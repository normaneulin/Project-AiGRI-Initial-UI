<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damage Assessment | AiGRI</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/leaflet-overrides.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="dashboard">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>AiGRI Portal</h2>
            <p>Municipal Agriculture Office</p>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="register-farm.html"><i class="fas fa-map-marked-alt"></i> Register Farm</a></li>
                <li><a href="assess-damage.html" class="active"><i class="fas fa-clipboard-check"></i> Damage Assessment</a></li>
                <li><a href="#"><i class="fas fa-users"></i> Farmers</a></li>
                <li><a href="#"><i class="fas fa-file-alt"></i> Reports</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <div class="content-header">
            <h1>Damage Assessment</h1>
            <div class="user-profile">
                <img src="../img/user-avatar.jpg" alt="User Avatar">
                <span>Municipal Agriculture Officer</span>
            </div>
        </div>

        <div class="form-container">
            <h2 class="form-title">Initiate New Assessment</h2>
            
            <form id="damage-assessment-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="farmer-select">Select Farmer</label>
                        <select id="farmer-select" required>
                            <option value="">Select farmer</option>
                            <option value="1">Juan Dela Cruz - RSBSA: 123456789</option>
                            <option value="2">Maria Santos - RSBSA: 987654321</option>
                            <option value="3">Roberto Garcia - RSBSA: 456789123</option>
                            <option value="4">Luzviminda Reyes - RSBSA: 321654987</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="disaster-type">Disaster Type</label>
                        <select id="disaster-type" required>
                            <option value="">Select disaster</option>
                            <option value="typhoon">Typhoon</option>
                            <option value="drought">Drought</option>
                            <option value="flood">Flood</option>
                            <option value="pest">Pest Infestation</option>
                            <option value="disease">Crop Disease</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="disaster-date">Date of Disaster</label>
                    <input type="date" id="disaster-date" required>
                </div>
                
                <div class="form-group">
                    <label>Before Disaster Images</label>
                    <input type="file" id="before-images" multiple accept="image/*" required>
                    <p class="help-text">Upload baseline images of the farm before the disaster</p>
                </div>
                
                <div class="form-group">
                    <label>After Disaster Images</label>
                    <input type="file" id="after-images" multiple accept="image/*" required>
                    <p class="help-text">Upload images of the farm after the disaster</p>
                </div>
                
                <div class="form-group">
                    <label>Farm Boundary</label>
                    <div class="map-container" id="damage-map"></div>
                    <p class="help-text">Farm boundary will be automatically loaded</p>
                </div>
                
                <input type="hidden" id="boundary-coords" value='[{"lat":12.8797,"lng":121.774},{"lat":12.8807,"lng":121.775},{"lat":12.8817,"lng":121.773},{"lat":12.8807,"lng":121.772}]'>
                <input type="hidden" id="before-image-url">
                <input type="hidden" id="after-image-url">
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit for Assessment</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="../js/map.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Initialize form submission
            const form = document.getElementById('damage-assessment-form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm(form)) {
                    return;
                }
                
                // Prepare assessment data
                const assessmentData = {
                    farmerId: document.getElementById('farmer-select').value,
                    disasterType: document.getElementById('disaster-type').value,
                    disasterDate: document.getElementById('disaster-date').value,
                    boundaryCoordinates: JSON.parse(document.getElementById('boundary-coords').value),
                    beforeImages: document.getElementById('before-image-url').value,
                    afterImages: document.getElementById('after-image-url').value
                };
                
                try {
                    // Simulate API call - replace with actual API call in production
                    console.log('Submitting assessment data:', assessmentData);
                    
                    // Show success message
                    alert('Assessment successfully submitted! AI processing will begin shortly.');
                    
                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } catch (error) {
                    console.error('Error submitting assessment:', error);
                    alert('Error submitting assessment. Please try again.');
                }
            });
            
            // Handle image uploads (simulated)
            document.getElementById('before-images').addEventListener('change', function() {
                // In a real implementation, this would upload to your backend
                console.log('Before images selected:', this.files);
                document.getElementById('before-image-url').value = 'https://example.com/before.jpg';
            });
            
            document.getElementById('after-images').addEventListener('change', function() {
                // In a real implementation, this would upload to your backend
                console.log('After images selected:', this.files);
                document.getElementById('after-image-url').value = 'https://example.com/after.jpg';
            });
        });
        
        function validateForm(form) {
            let isValid = true;
            
            // Check required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });
            
            return isValid;
        }
    </script>
</body>
</html>